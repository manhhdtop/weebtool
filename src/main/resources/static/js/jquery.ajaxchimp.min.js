(function($)
{
	'use strict';

	$.ajaxChimp = {
	    responses : {
	        'Chúng tôi đã gửi cho bạn một email xác nhận' : 0,
	        'Vui lòng nhập email hợp lệ.' : 1,
	        'Email phải chứa một ký tự @' : 2,
	        'Tên miền của email không hợp lệ (sau @: )' : 3,
	        'Tên email không hợp lệ (trước @: )' : 4,
	        'Email là giả hoặc không hợp lệ, Vui lòng nhập email hợp lệ.' : 5
	    },
	    translations : {
		    'vi' : null
	    },
	    init : function(selector, options)
	    {
		    $(selector).ajaxChimp(options);
	    }
	};

	$.fn.ajaxChimp = function(options)
	{
		$(this).each(function(i, elem)
		{
			var form = $(elem);
			var email = form.find('input[type=email]');
			var label = form.find('.info');

			var settings = $.extend({
			    'url' : form.attr('action'),
			    'language' : 'vi'
			}, options);

			var url = settings.url.replace('/post?', '/post-json?').concat('&c=?');

			form.attr('novalidate', 'true');
			email.attr('name', 'EMAIL');

			form.submit(function()
			{
				var msg;
				function successCallback(resp)
				{
					if (resp.result === 'success')
					{
						msg = 'Chúng tôi đã gửi cho bạn một email xác nhận';
						label.removeClass('error').addClass('valid');
						email.removeClass('error').addClass('valid');
					}
					else
					{
						email.removeClass('valid').addClass('error');
						label.removeClass('valid').addClass('error');
						var index = -1;
						try
						{
							var parts = resp.msg.split(' - ', 2);
							if (parts[1] === undefined)
							{
								msg = resp.msg;
							}
							else
							{
								var i = parseInt(parts[0], 10);
								if (i.toString() === parts[0])
								{
									index = parts[0];
									msg = parts[1];
								}
								else
								{
									index = -1;
									msg = resp.msg;
								}
							}
						}
						catch (e)
						{
							index = -1;
							msg = resp.msg;
						}
					}

					msg = $.ajaxChimp.translations[settings.language][$.ajaxChimp.responses[msg]];

					label.html(msg);

					label.show(2000);
					if (settings.callback)
					{
						settings.callback(resp);
					}
				}

				var data = {};
				var dataArray = form.serializeArray();
				$.each(dataArray, function(index, item)
				{
					data[item.name] = item.value;
				});

				$.ajax({
				    url : url,
				    data : data,
				    success : successCallback,
				    dataType : 'jsonp',
				    error : function(resp, text)
				    {
					    msg = 'Có lỗi khi gửi mail';
					    label.html(msg);
				    }
				});

				// Translate and display submit message
				var submitMsg = 'Đang gửi...';

				submitMsg = $.ajaxChimp.translations[settings.language]['Gửi'];

				label.html(submitMsg).show(2000);

				return false;
			});
		});
		return this;
	};
})(jQuery);